#!/bin/bash
cd "$(git rev-parse --show-toplevel)"

# Get version from pubspec.yaml
VERSION=$(grep 'version:' pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)

# Get current commit info
CURRENT_AUTHOR=$(git config user.name)
CURRENT_EMAIL=$(git config user.email)
CURRENT_DATE=$(date +%Y-%m-%d)
CURRENT_MESSAGE=$(git log -1 --pretty=%B 2>/dev/null || echo "Current changes")

# Create version info file
cat > lib/common/build_info.dart << EOF
// Auto-generated by git hook - DO NOT EDIT
class BuildInfo {
  // Version 1.0.1
  // Core build info
  static const String version = '$VERSION';
  static const String buildDate = '$(date +%Y-%m-%d %H:%M:%S)';
  
  // Git info
  static const String commitHash = '$(git rev-parse --short HEAD)';
  static const String branch = '$(git rev-parse --abbrev-ref HEAD)';
  static const String lastTag = '$(git describe --tags --abbrev=0 2>/dev/null || echo "no tag")';
  
  // Author of last commit
  static const String lastCommitAuthor = '$(git log -1 --pretty=format:"%an")';
  static const String lastCommitEmail = '$(git log -1 --pretty=format:"%ae")';
  
  // Recent commits (current + last 4)
  static const List<Map<String, String>> recentCommits = [
    {
      "hash": "current",
      "author": "$CURRENT_AUTHOR",
      "email": "$CURRENT_EMAIL", 
      "message": "$CURRENT_MESSAGE",
      "date": "$CURRENT_DATE",
      "relativeDate": "now"
    },
$(git log -n 4 --pretty=format:'    {
      "hash": "%h",
      "author": "%an",
      "email": "%ae", 
      "message": "%s",
      "date": "%ad",
      "relativeDate": "%ar"
    },' --date=short)
  ];

  // Stats
  static const String totalCommits = '$(git rev-list --count HEAD)';
  static const String contributors = '$(git shortlog -sn --no-merges | wc -l)';
}
EOF

# Stage the generated file
git add lib/common/build_info.dart